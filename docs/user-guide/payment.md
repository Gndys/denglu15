# ğŸ’³ æ”¯ä»˜é…ç½®æŒ‡å—

æ”¯ä»˜æ˜¯æˆ‘ä»¬é‡è¦çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œç›®å‰æˆ‘ä»¬æ”¯æŒä¸‰ç§æ”¯ä»˜æ–¹å¼ï¼š**WeChat Pay**ã€**Stripe** å’Œ **Creem**ï¼Œå¹¶ä¸”æ”¯æŒå•æ¬¡ä»˜è´¹å’Œè®¢é˜…ä¸¤ç§æ¨¡å¼ï¼ˆå¾®ä¿¡æ”¯ä»˜åªæ”¯æŒå•æ¬¡ä»˜è´¹ï¼‰ã€‚

## ğŸ“‘ ç›®å½•

- [ğŸ¯ æ”¯æŒçš„æ”¯ä»˜æ–¹å¼](#-æ”¯æŒçš„æ”¯ä»˜æ–¹å¼)
- [âš™ï¸ é…ç½®æ¦‚è§ˆ](#ï¸-é…ç½®æ¦‚è§ˆ)
- [ğŸ”§ ç¯å¢ƒå˜é‡ç”³è¯·å’Œé…ç½®](#ï¸-ç¯å¢ƒå˜é‡ç”³è¯·å’Œé…ç½®)
  - [1. WeChat Pay (å¾®ä¿¡æ”¯ä»˜)](#1-wechat-pay-å¾®ä¿¡æ”¯ä»˜)
  - [2. Stripe](#2-stripe)
  - [3. Creem](#3-creem)
- [ğŸ“‹ å®Œæ•´ç¯å¢ƒå˜é‡æ¨¡æ¿](#-å®Œæ•´ç¯å¢ƒå˜é‡æ¨¡æ¿)
- [ğŸ“¦ é…ç½®ä»˜æ¬¾è®¡åˆ’](#-é…ç½®ä»˜æ¬¾è®¡åˆ’)
  - [ğŸ’° è®¡åˆ’ç±»å‹](#-è®¡åˆ’ç±»å‹)
  - [ğŸ› ï¸ è®¡åˆ’é…ç½®ç¤ºä¾‹](#ï¸-è®¡åˆ’é…ç½®ç¤ºä¾‹)
  - [ğŸ”— è·å–ä»·æ ¼ ID](#-è·å–ä»·æ ¼-id)
  - [âš™ï¸ å­—æ®µè¯´æ˜](#ï¸-å­—æ®µè¯´æ˜)
  - [ğŸŒ å›½é™…åŒ–é…ç½®](#-å›½é™…åŒ–é…ç½®)
- [ğŸ§ª æµ‹è¯•é…ç½®](#-æµ‹è¯•é…ç½®)
  - [æµ‹è¯•ç¯å¢ƒè®¾ç½®](#æµ‹è¯•ç¯å¢ƒè®¾ç½®)
  - [æœ¬åœ°å¼€å‘æµ‹è¯•](#æœ¬åœ°å¼€å‘æµ‹è¯•)
- [ğŸ”„ æ”¯ä»˜æµç¨‹](#-æ”¯ä»˜æµç¨‹)
  - [æ”¯ä»˜å¤„ç†æµç¨‹](#æ”¯ä»˜å¤„ç†æµç¨‹)
  - [API ç«¯ç‚¹](#api-ç«¯ç‚¹)
- [ğŸ“š å‚è€ƒæ–‡æ¡£](#-å‚è€ƒæ–‡æ¡£)
  - [å¾®ä¿¡æ”¯ä»˜](#å¾®ä¿¡æ”¯ä»˜)
  - [å…¶ä»–æ”¯ä»˜å¹³å°](#å…¶ä»–æ”¯ä»˜å¹³å°)

## ğŸ¯ æ”¯æŒçš„æ”¯ä»˜æ–¹å¼

| æ”¯ä»˜æ–¹å¼ | å•æ¬¡ä»˜è´¹ | è®¢é˜…ä»˜è´¹ | ä¸»è¦å¸‚åœº | å¸ç§æ”¯æŒ |
|---------|---------|---------|---------|---------|
| WeChat Pay | âœ… | âŒ | ä¸­å›½å¤§é™† | CNY |
| Stripe | âœ… | âœ… | å…¨çƒ | å¤šå¸ç§ |
| Creem | âœ… | âœ… | å…¨çƒ | USD, EURç­‰ |

## âš™ï¸ é…ç½®æ¦‚è§ˆ

é€šè¿‡ `config.ts` ä¸­çš„ **payment.providers** è¿›è¡Œè®¾ç½®ã€‚å»ºè®®æ‚¨æ ¹æ®é¡¹ç›®éœ€æ±‚å’Œç›®æ ‡å¸‚åœºé€‰æ‹©ä¸€ç§æ”¯ä»˜æ–¹å¼è¿›è¡Œé…ç½®ï¼š

- **ä¸­å›½å¤§é™†ç”¨æˆ·**ï¼šæ¨è WeChat Pay
- **å›½é™…ç”¨æˆ·**ï¼šæ¨è Stripe 
- **å®¡æ ¸é€šè¿‡æ›´å®¹æ˜“**ï¼šæ¨è Creem

**ç‰¹åˆ«æ³¨æ„ï¼šåœ¨æœ¬åœ°å¼€å‘é˜¶æ®µæˆ‘ä»¬è¦ä½¿ç”¨è¿™äº›å¹³å°çš„æµ‹è¯•/æ²™ç›’æ¨¡å¼ï¼ˆStripe å’Œ Creem æ”¯æŒï¼Œå¾®ä¿¡æ”¯ä»˜ä¸æ”¯æŒï¼‰ï¼Œæ‰€ä»¥å¾®ä¿¡æ”¯ä»˜å¦‚æœæƒ³æµ‹è¯•éƒ½æ˜¯ä½¿ç”¨çœŸå® 0.01 å…ƒçœŸå®æ”¯ä»˜è¿›è¡Œæµ‹è¯•ã€‚**

## ğŸ”§ ç¯å¢ƒå˜é‡ç”³è¯·å’Œé…ç½®

### 1. WeChat Pay (å¾®ä¿¡æ”¯ä»˜)

å¾®ä¿¡æ”¯ä»˜æ˜¯ä¸­å›½å¤§é™†åœ°åŒºæœ€ä¸»è¦çš„æ”¯ä»˜æ–¹å¼ï¼Œé€‚åˆé¢å‘ä¸­å›½ç”¨æˆ·çš„åº”ç”¨ï¼ˆéœ€è¦ä¼ä¸šèµ„è´¨ï¼Œä¸ªäººæ— æ³•ç”³è¯·ï¼‰ã€‚

#### ğŸ“‹ ç”³è¯·æµç¨‹

1. **æ³¨å†Œå¾®ä¿¡å•†æˆ·å¹³å°è´¦å·**
   - è®¿é—® [å¾®ä¿¡æ”¯ä»˜å•†æˆ·å¹³å°](https://pay.weixin.qq.com/)
   - å‡†å¤‡ä¼ä¸šè¥ä¸šæ‰§ç…§ã€æ³•äººèº«ä»½è¯ç­‰èµ„æ–™
   - å®Œæˆä¼ä¸šè®¤è¯å’Œè´¦æˆ·å®¡æ ¸ï¼ˆé€šå¸¸éœ€è¦1-7ä¸ªå·¥ä½œæ—¥ï¼‰

2. **è·å–å¿…è¦å‚æ•°**
   - **App ID**: å¾®ä¿¡å…¬ä¼—å·æˆ–å°ç¨‹åºçš„åº”ç”¨ID
   - **å•†æˆ·å· (Mch ID)**: å¾®ä¿¡æ”¯ä»˜åˆ†é…çš„å•†æˆ·å·
   - **APIå¯†é’¥ (API Key)**: åœ¨å•†æˆ·å¹³å°çš„è´¦æˆ·è®¾ç½®ä¸­ç”Ÿæˆ

3. **ä¸‹è½½æ”¯ä»˜è¯ä¹¦**
   - åœ¨å•†æˆ·å¹³å°çš„"è´¦æˆ·ä¸­å¿ƒ" â†’ "APIå®‰å…¨"ä¸­ä¸‹è½½è¯ä¹¦
   - ä¸‹è½½ `apiclient_key.pem`ï¼ˆç§é’¥ï¼‰å’Œ `apiclient_cert.pem`ï¼ˆè¯ä¹¦ï¼‰
   - å°†è¯ä¹¦å†…å®¹è½¬æ¢ä¸ºç¯å¢ƒå˜é‡æ ¼å¼ï¼ˆè§ä¸‹æ–¹é…ç½®è¯´æ˜ï¼‰

4. **è·å–å¾®ä¿¡æ”¯ä»˜å…¬é’¥ï¼ˆæ¨èï¼Œéå¿…éœ€ï¼‰**
   
   å¾®ä¿¡æ”¯ä»˜æä¾›ä¸¤ç§ç­¾åéªŒè¯æ–¹å¼ï¼š
   
   **æ–¹å¼1ï¼šå¾®ä¿¡æ”¯ä»˜å…¬é’¥éªŒè¯ï¼ˆæ¨èï¼‰**
   - âœ… å®˜æ–¹æ¨èçš„æ–°æ–¹å¼ï¼ˆ2024å¹´æ¨å‡ºï¼‰
   - âœ… æ€§èƒ½æ›´å¥½ï¼Œæ— éœ€é¢å¤–ç½‘ç»œè¯·æ±‚
   - âœ… æ— æœ‰æ•ˆæœŸé™åˆ¶ï¼Œæ›´ç¨³å®š
   - âš™ï¸ éœ€è¦æ‰‹åŠ¨é…ç½®ç¯å¢ƒå˜é‡
   
   **æ–¹å¼2ï¼šå¹³å°è¯ä¹¦éªŒè¯ï¼ˆè‡ªåŠ¨å›é€€ï¼‰**
   - ğŸ”„ ä¼ ç»ŸéªŒè¯æ–¹å¼
   - ğŸ”„ **å½“æœªé…ç½®å…¬é’¥æ—¶è‡ªåŠ¨ä½¿ç”¨**
   - âŒ ç³»ç»Ÿå†…éƒ¨ä¼šå¤šå‘ä¸€æ¬¡è¯·æ±‚è·å–è¯ä¹¦
   - âš ï¸ è¯ä¹¦æœ‰5å¹´æœ‰æ•ˆæœŸ
   
   **è·å–æ­¥éª¤**ï¼ˆä»…å½“é€‰æ‹©æ–¹å¼1æ—¶éœ€è¦ï¼‰ï¼š
   - åœ¨å•†æˆ·å¹³å°çš„"è´¦æˆ·ä¸­å¿ƒ" â†’ "APIå®‰å…¨"é¡µé¢
   - ç‚¹å‡»"ç”³è¯·å…¬é’¥"å¹¶ä¸‹è½½å¾®ä¿¡æ”¯ä»˜å…¬é’¥
   - è·å–å…¬é’¥IDï¼ˆåœ¨ä¸‹è½½é¡µé¢æ˜¾ç¤ºï¼‰

5. **é…ç½®å›è°ƒåŸŸå**
  - åœ¨ç¯å¢ƒå˜é‡ä¸­è®¾ç½®ï¼Œè¯·çœ‹ç¯å¢ƒå˜é‡é…ç½®ç¯èŠ‚

#### ğŸ”‘ ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```env
# WeChat Pay å¾®ä¿¡æ”¯ä»˜é…ç½®
WECHAT_PAY_APP_ID=wx1234567890abcdef    # å¾®ä¿¡åº”ç”¨ID
WECHAT_PAY_MCH_ID=1234567890            # å•†æˆ·å·
WECHAT_PAY_API_KEY=your-32-char-api-key # APIå¯†é’¥
# éœ€è¦è®¾ç½®æˆä¸ºå…¬ç½‘åœ°å€ï¼Œä½¿ç”¨å†…ç½‘ç©¿é€å·¥å…·, åé¢çš„ endpoint /api/payment/webhook/wechat ä¸éœ€è¦ä¿®æ”¹
# å…·ä½“å·¥å…·æ•™ç¨‹è¯·å‚çœ‹ï¼Œä¸‹é¢çš„ æœ¬åœ°å¼€å‘æµ‹è¯• ç¯èŠ‚
WECHAT_PAY_NOTIFY_URL=https://yourdomain.com/api/payment/webhook/wechat

# å¾®ä¿¡æ”¯ä»˜è¯ä¹¦é…ç½®ï¼ˆå¿…éœ€ï¼‰- å•†æˆ·è¯ä¹¦ï¼Œç”¨äºè¯·æ±‚ç­¾å
WECHAT_PAY_PRIVATE_KEY="-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEA...\n-----END RSA PRIVATE KEY-----"
WECHAT_PAY_PUBLIC_KEY="-----BEGIN CERTIFICATE-----\nMIIEpDCCA4ygAwIBAgIU...\n-----END CERTIFICATE-----"

# å¾®ä¿¡æ”¯ä»˜å…¬é’¥éªŒè¯ï¼ˆæ¨èï¼Œéå¿…éœ€ï¼‰
# é…ç½®åå¯è·å¾—æ›´å¥½æ€§èƒ½ï¼Œæœªé…ç½®æ—¶è‡ªåŠ¨ä½¿ç”¨å¹³å°è¯ä¹¦éªŒè¯ï¼ˆä¼šå¢åŠ ä¸€æ¬¡ç½‘ç»œè¯·æ±‚ï¼‰
WECHAT_PAY_PAYMENT_PUBLIC_KEY="-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...\n-----END PUBLIC KEY-----"
WECHAT_PAY_PUBLIC_KEY_ID="PUB_KEY_ID_0000000000000024101100397200000006"
```

#### ğŸ“‹ è¯ä¹¦æ ¼å¼è½¬æ¢

å¦‚æœä½ å·²æœ‰è¯ä¹¦æ–‡ä»¶ï¼Œéœ€è¦å°†å…¶è½¬æ¢ä¸ºå•è¡Œæ ¼å¼ï¼š

```bash
# è½¬æ¢å•†æˆ·ç§é’¥
awk '{printf "%s\\n", $0}' apiclient_key.pem

# è½¬æ¢å•†æˆ·è¯ä¹¦  
awk '{printf "%s\\n", $0}' apiclient_cert.pem

# è½¬æ¢å¾®ä¿¡æ”¯ä»˜å…¬é’¥ï¼ˆä»å•†æˆ·å¹³å°ä¸‹è½½çš„ .pem æ–‡ä»¶ï¼‰
awk '{printf "%s\\n", $0}' pub_key.pem
```

å°†è¾“å‡ºç»“æœåˆ†åˆ«å¤åˆ¶åˆ°å¯¹åº”çš„ç¯å¢ƒå˜é‡ä¸­ã€‚

#### ğŸ”’ éªŒè¯æ–¹å¼è¯´æ˜

ç³»ç»Ÿæ”¯æŒä¸¤ç§ç­¾åéªŒè¯æ–¹å¼ï¼Œä¼šæ™ºèƒ½é€‰æ‹©æœ€ä½³æ–¹æ¡ˆï¼š

| éªŒè¯æ–¹å¼ | é…ç½®è¦æ±‚ | æ€§èƒ½å½±å“ | æ˜¯å¦å¿…éœ€ | è¯´æ˜ |
|---------|---------|---------|---------|------|
| **å¾®ä¿¡æ”¯ä»˜å…¬é’¥éªŒè¯** | `WECHAT_PAY_PAYMENT_PUBLIC_KEY` + `WECHAT_PAY_PUBLIC_KEY_ID` | âš¡ æ€§èƒ½æœ€ä½³ | âŒ **éå¿…éœ€** | 2024å¹´æ¨å‡ºï¼Œæ— æœ‰æ•ˆæœŸï¼Œæ¨èé…ç½® |
| å¹³å°è¯ä¹¦éªŒè¯ | ä»…éœ€å•†æˆ·è¯ä¹¦ | ğŸ”„ é¢å¤–ç½‘ç»œè¯·æ±‚ | âœ… **è‡ªåŠ¨å›é€€** | æœªé…ç½®å…¬é’¥æ—¶è‡ªåŠ¨ä½¿ç”¨ï¼Œè¯ä¹¦5å¹´æœ‰æ•ˆæœŸ |

**é…ç½®å»ºè®®**ï¼š
- ğŸš€ **æœ€ä½³æ€§èƒ½**ï¼šé…ç½®å¾®ä¿¡æ”¯ä»˜å…¬é’¥ï¼ˆé¿å…é¢å¤–ç½‘ç»œè¯·æ±‚ï¼‰
- ğŸ”„ **æœ€ç®€é…ç½®**ï¼šä»…é…ç½®å•†æˆ·è¯ä¹¦ï¼ˆç³»ç»Ÿè‡ªåŠ¨å¤„ç†ï¼Œä½†æ€§èƒ½ç•¥ä½ï¼‰
- ğŸ›¡ï¸ **æ¨èæ–¹æ¡ˆ**ï¼šåŒæ—¶é…ç½®ï¼Œè·å¾—æœ€ä½³æ€§èƒ½å’Œå…¼å®¹æ€§

#### ğŸ“¥ è·å–å¾®ä¿¡æ”¯ä»˜å…¬é’¥çš„è¯¦ç»†æ­¥éª¤ï¼ˆå¯é€‰é…ç½®ï¼‰

> **âš¡ æ€§èƒ½æç¤º**ï¼šé…ç½®å¾®ä¿¡æ”¯ä»˜å…¬é’¥å¯é¿å…ç³»ç»Ÿå†…éƒ¨çš„é¢å¤–ç½‘ç»œè¯·æ±‚ï¼Œæå‡æ”¯ä»˜éªŒè¯æ€§èƒ½ã€‚æœªé…ç½®æ—¶ç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨å¹³å°è¯ä¹¦éªŒè¯ï¼ˆåŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼Œä½†ä¼šæœ‰é¢å¤–çš„ç½‘ç»œå¼€é”€ï¼‰ã€‚

**ä»…å½“éœ€è¦æœ€ä½³æ€§èƒ½æ—¶æ‰éœ€è¦ä»¥ä¸‹æ­¥éª¤**ï¼š

1. **ç™»å½•å¾®ä¿¡æ”¯ä»˜å•†æˆ·å¹³å°**
   - è®¿é—® [å¾®ä¿¡æ”¯ä»˜å•†æˆ·å¹³å°](https://pay.weixin.qq.com/)
   - ä½¿ç”¨è¶…çº§ç®¡ç†å‘˜æˆ–å®‰å…¨è”ç³»äººè´¦å·ç™»å½•

2. **è¿›å…¥APIå®‰å…¨é¡µé¢**
   - ç‚¹å‡»å·¦ä¾§èœå•çš„"è´¦æˆ·ä¸­å¿ƒ"
   - é€‰æ‹©"APIå®‰å…¨"å­èœå•

3. **ç”³è¯·å¹¶ä¸‹è½½å…¬é’¥**
   - åœ¨é¡µé¢ä¸­æ‰¾åˆ°"å¾®ä¿¡æ”¯ä»˜å…¬é’¥"éƒ¨åˆ†
   - ç‚¹å‡»"ç”³è¯·å…¬é’¥"æŒ‰é’®
   - ä¸‹è½½ç”Ÿæˆçš„å…¬é’¥æ–‡ä»¶ï¼ˆ.pemæ ¼å¼ï¼‰

4. **è·å–å…¬é’¥ID**
   - åœ¨ä¸‹è½½é¡µé¢æˆ–å…¬é’¥è¯¦æƒ…é¡µé¢å¯ä»¥çœ‹åˆ°å…¬é’¥ID
   - å…¬é’¥IDæ ¼å¼ç±»ä¼¼ï¼š`PUB_KEY_ID_0000000000000024101100397200000006`
   - å¤åˆ¶æ­¤IDç”¨äºç¯å¢ƒå˜é‡é…ç½®

5. **é…ç½®ç¯å¢ƒå˜é‡**
   - ä½¿ç”¨ä¸Šé¢çš„è½¬æ¢å‘½ä»¤å°†å…¬é’¥æ–‡ä»¶è½¬æ¢ä¸ºå•è¡Œæ ¼å¼
   - åˆ†åˆ«é…ç½® `WECHAT_PAY_PAYMENT_PUBLIC_KEY` å’Œ `WECHAT_PAY_PUBLIC_KEY_ID`

ğŸ“– **å‚è€ƒæ–‡æ¡£**ï¼š[å¾®ä¿¡æ”¯ä»˜å…¬é’¥éªŒè¯æŒ‡å¼•](https://pay.weixin.qq.com/doc/v3/merchant/4013053249)

ğŸ’¡ **å¿«é€Ÿå¼€å§‹**ï¼šå¦‚æœæƒ³å¿«é€Ÿå¼€å§‹ï¼Œå¯ä»¥è·³è¿‡æ­¤æ­¥éª¤ï¼Œä»…é…ç½®å•†æˆ·è¯ä¹¦å³å¯æ­£å¸¸ä½¿ç”¨å¾®ä¿¡æ”¯ä»˜åŠŸèƒ½ã€‚

#### âš ï¸ æ³¨æ„äº‹é¡¹

- å¾®ä¿¡æ”¯ä»˜åªæ”¯æŒ CNY (äººæ°‘å¸) å¸ç§
- ä»…æ”¯æŒå•æ¬¡ä»˜è´¹ï¼Œä¸æ”¯æŒè®¢é˜…æ¨¡å¼
- éœ€è¦ä¼ä¸šèµ„è´¨ï¼Œä¸ªäººæ— æ³•ç”³è¯·
- å›è°ƒåœ°å€å¿…é¡»ä½¿ç”¨ HTTPS
- è¯ä¹¦å†…å®¹åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œè¯·ç¡®ä¿ç¯å¢ƒå˜é‡å®‰å…¨
- **æ¨èé…ç½®å¾®ä¿¡æ”¯ä»˜å…¬é’¥**ï¼šéå¿…éœ€ï¼Œä½†å¯è·å¾—æ›´å¥½æ€§èƒ½ï¼ˆé¿å…é¢å¤–ç½‘ç»œè¯·æ±‚ï¼‰
- **è‡ªåŠ¨å›é€€æœºåˆ¶**ï¼šæœªé…ç½®å…¬é’¥æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨å¹³å°è¯ä¹¦éªŒè¯

### 2. Stripe

Stripe æ˜¯å…¨çƒé¢†å…ˆçš„åœ¨çº¿æ”¯ä»˜å¹³å°ï¼Œæ”¯æŒå¤šç§å¸ç§å’Œæ”¯ä»˜æ–¹å¼ï¼Œç‰¹åˆ«é€‚åˆå›½é™…ä¸šåŠ¡ã€‚

#### ğŸ“‹ ç”³è¯·æµç¨‹

1. **æ³¨å†Œ Stripe è´¦å·**
   - è®¿é—® [Stripe å®˜ç½‘](https://stripe.com/)
   - ä½¿ç”¨é‚®ç®±æ³¨å†Œè´¦å·
   - å®Œæˆèº«ä»½éªŒè¯ï¼ˆéœ€è¦æä¾›ä¼ä¸šæˆ–ä¸ªäººä¿¡æ¯ï¼‰

2. **è·å– API å¯†é’¥**
   - ç™»å½• Stripe Dashboard
   - å‰å¾€ "å¼€å‘è€…" â†’ "API å¯†é’¥"
   - è·å–å¯å‘å¸ƒå¯†é’¥ (Publishable Key) å’Œç§˜å¯†å¯†é’¥ (Secret Key)

3. **åˆ›å»ºäº§å“å’Œä»·æ ¼**
   - åœ¨ Dashboard åˆ›å»ºäº§å“ (Products)
   - ä¸ºæ¯ä¸ªäº§å“åˆ›å»ºä»·æ ¼ (Prices)
   - è®°å½•ä»·æ ¼IDï¼Œç”¨äºé…ç½® `stripePriceId`

4. **é…ç½® Webhookï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰**
   
   > ğŸ’¡ **å¼€å‘ç¯å¢ƒæç¤º**ï¼šå¦‚æœæ˜¯æœ¬åœ°å¼€å‘æµ‹è¯•ï¼Œå¯ä»¥å…ˆè·³è¿‡æ­¤æ­¥éª¤ï¼Œä½¿ç”¨ Stripe CLI è¿›è¡Œ webhook è½¬å‘å³å¯ã€‚è¯¦è§ä¸‹æ–¹çš„ [æœ¬åœ°å¼€å‘æµ‹è¯•](#æœ¬åœ°å¼€å‘æµ‹è¯•) ç« èŠ‚ã€‚
   
   **ç”Ÿäº§ç¯å¢ƒé…ç½®ï¼š**
   - å‰å¾€ "å¼€å‘è€…" â†’ "Webhooks"
   - æ·»åŠ ç«¯ç‚¹ï¼š`https://yourdomain.com/api/payment/webhook/stripe`
   - é€‰æ‹©äº‹ä»¶ï¼š`checkout.session.completed`, `payment_intent.succeeded`
   - è®°å½• Webhook ç­¾åç§˜é’¥ï¼Œç”¨äºç¯å¢ƒå˜é‡ `STRIPE_WEBHOOK_SECRET`

#### ğŸ”‘ ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```env
# Stripe é…ç½®
STRIPE_SECRET_KEY=sk_test_xxxxxxxx        # ç§˜å¯†å¯†é’¥ (ç”Ÿäº§ç¯å¢ƒç”¨ sk_live_)
STRIPE_PUBLIC_KEY=pk_test_xxxxxxxx        # å¯å‘å¸ƒå¯†é’¥ (ç”Ÿäº§ç¯å¢ƒç”¨ pk_live_)
STRIPE_WEBHOOK_SECRET=whsec_xxxxxxxx      # Webhook ç­¾åç§˜é’¥ (æœ¬åœ°å¼€å‘ç”¨ Stripe CLI æ—¶ä¼šè‡ªåŠ¨ç”Ÿæˆ)
```

> ğŸ“ **å¼€å‘ç¯å¢ƒè¯´æ˜**ï¼š
> - ä½¿ç”¨ Stripe CLI è¿›è¡Œæœ¬åœ°å¼€å‘æ—¶ï¼Œ`STRIPE_WEBHOOK_SECRET` ä¼šåœ¨è¿è¡Œ `stripe listen` å‘½ä»¤æ—¶è‡ªåŠ¨ç”Ÿæˆ
> - ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ—¶ï¼Œéœ€è¦åœ¨ Stripe Dashboard åˆ›å»º Webhook ç«¯ç‚¹å¹¶è·å–ç­¾åç§˜é’¥

#### âœ¨ ç‰¹æ€§

- æ”¯æŒå…¨çƒå¤šç§å¸ç§ (USD, EUR, CNY, JPY ç­‰)
- æ”¯æŒå•æ¬¡ä»˜è´¹å’Œè®¢é˜…æ¨¡å¼
- æ”¯æŒä¿¡ç”¨å¡ã€å€Ÿè®°å¡ã€æ•°å­—é’±åŒ…ç­‰å¤šç§æ”¯ä»˜æ–¹å¼
- ä¸ªäººå’Œä¼ä¸šå‡å¯ç”³è¯·

### 3. Creem

Creem æ˜¯æ–°å…´çš„æ”¯ä»˜å¹³å°ï¼Œæä¾›çµæ´»çš„å®šä»·å’Œè®¢é˜…ç®¡ç†åŠŸèƒ½ã€‚å®ƒæ¯” Stripe çš„è¦æ±‚æ›´ç®€å•ï¼Œæ˜¯éå¸¸é€‚åˆç‹¬ç«‹å¼€å‘è€…å‡ºæµ·çš„å¹³å°ã€‚

#### ğŸ“‹ ç”³è¯·æµç¨‹

1. **æ³¨å†Œ Creem è´¦å·**
   - è®¿é—® [Creem å®˜ç½‘](https://creem.io/)
   - æ³¨å†Œè´¦å·å¹¶å®ŒæˆéªŒè¯

2. **è·å– API å¯†é’¥**
   - ç™»å½• Creem Dashboard
   - å‰å¾€ API è®¾ç½®é¡µé¢
   - ç”Ÿæˆ API Key å’Œ Webhook Secret

3. **åˆ›å»ºäº§å“**
   - ä½¿ç”¨ API æˆ– Dashboard åˆ›å»ºäº§å“
   - é…ç½®ä»·æ ¼å’Œè®¢é˜…å‘¨æœŸ
   - è®°å½•äº§å“IDï¼Œç”¨äºé…ç½® `creemProductId`

4. **é…ç½® Webhook**
   - å‰å¾€ "Developers" â†’ "Webhooks"
   - æ·»åŠ  Webhook URLï¼š`https://yourdomain.com/api/payment/webhook/stripe`

#### ğŸ”‘ ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```env
# Creem é…ç½®
CREEM_API_KEY=creem_xxxxxxxx             # API å¯†é’¥
CREEM_SERVER_URL=https://api.creem.io    # æœåŠ¡å™¨åœ°å€ (å¯é€‰ï¼Œé»˜è®¤ä¸ºæµ‹è¯•ç¯å¢ƒ)
CREEM_WEBHOOK_SECRET=whsec_xxxxxxxx      # Webhook ç­¾åç§˜é’¥
```

#### âœ¨ ç‰¹æ€§

- æ”¯æŒå¤šç§å¸ç§
- çµæ´»çš„å®šä»·æ¨¡å‹
- æ”¯æŒå•æ¬¡ä»˜è´¹å’Œè®¢é˜…æ¨¡å¼
- ç°ä»£åŒ–çš„ API è®¾è®¡

## ğŸ“‹ å®Œæ•´ç¯å¢ƒå˜é‡æ¨¡æ¿

å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°ä½ çš„ `.env` æ–‡ä»¶ä¸­ï¼Œæ ¹æ®éœ€è¦é…ç½®ç›¸åº”çš„æ”¯ä»˜æ–¹å¼ï¼š

```env
# ===========================================
# æ”¯ä»˜é…ç½® Payment Configuration  
# ===========================================

# WeChat Pay å¾®ä¿¡æ”¯ä»˜ (ä¸­å›½å¤§é™†)
WECHAT_PAY_APP_ID=wx1234567890abcdef
WECHAT_PAY_MCH_ID=1234567890
WECHAT_PAY_API_KEY=your-32-char-api-key
WECHAT_PAY_NOTIFY_URL=https://yourdomain.com/api/payment/webhook/wechat
# å¾®ä¿¡æ”¯ä»˜è¯ä¹¦é…ç½®ï¼ˆå¿…éœ€ï¼‰
WECHAT_PAY_PRIVATE_KEY="-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAK...\n-----END RSA PRIVATE KEY-----"
WECHAT_PAY_PUBLIC_KEY="-----BEGIN CERTIFICATE-----\nMIIEpDCCA4y...\n-----END CERTIFICATE-----"

# å¾®ä¿¡æ”¯ä»˜å…¬é’¥éªŒè¯ï¼ˆæ¨èï¼Œéå¿…éœ€ï¼‰
# é…ç½®åå¯è·å¾—æ›´å¥½æ€§èƒ½ï¼Œæœªé…ç½®æ—¶è‡ªåŠ¨ä½¿ç”¨å¹³å°è¯ä¹¦éªŒè¯ï¼ˆä¼šå¢åŠ ä¸€æ¬¡ç½‘ç»œè¯·æ±‚ï¼‰
WECHAT_PAY_PAYMENT_PUBLIC_KEY="-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...\n-----END PUBLIC KEY-----"
WECHAT_PAY_PUBLIC_KEY_ID="PUB_KEY_ID_0000000000000024101100397200000006"

# Stripe (å…¨çƒ)
STRIPE_SECRET_KEY=sk_test_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
STRIPE_PUBLIC_KEY=pk_test_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
STRIPE_WEBHOOK_SECRET=whsec_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# Creem (å…¨çƒ)
CREEM_API_KEY=creem_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
CREEM_SERVER_URL=https://api.creem.io
CREEM_WEBHOOK_SECRET=whsec_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```


## ğŸ“¦ é…ç½®ä»˜æ¬¾è®¡åˆ’

é€šè¿‡ `config.ts` ä¸­çš„ **payment.plans** é…ç½®äº§å“å®šä»·æ–¹æ¡ˆã€‚è¿™é‡Œé…ç½®çš„è®¡åˆ’ä¼šè‡ªåŠ¨æ˜¾ç¤ºåœ¨ `/pricing` é¡µé¢ä¸­ã€‚
é»˜è®¤é¡¹ç›®æœ‰æ‰€æœ‰ä¸‰ç§æ”¯ä»˜æ–¹å¼çš„å…­ç§ä»·æ ¼æ¡ç›®ä¾›å‚è€ƒã€‚

### ğŸ’° è®¡åˆ’ç±»å‹

ç³»ç»Ÿæ”¯æŒä¸¤ç§ä»˜è´¹æ¨¡å¼ï¼š

#### å•æ¬¡ä»˜è´¹ (One-time)

å•æ¬¡ä»˜è´¹é€‚ç”¨äºä¸éœ€è¦å®šæœŸç»­è´¹çš„åœºæ™¯ï¼Œç”¨æˆ·æ”¯ä»˜ä¸€æ¬¡å³å¯è·å¾—é•¿æœŸæˆ–æ°¸ä¹…çš„è®¿é—®æƒé™ã€‚

**é€‚ç”¨åœºæ™¯**ï¼š

1. **ğŸ¯ ç»ˆèº«ä¼šå‘˜è´­ä¹°**
   - ç”¨æˆ·ä¸€æ¬¡æ€§è´­ä¹°ï¼Œè·å¾—æ°¸ä¹…è®¿é—®æƒé™
   - è®¾ç½® `months: 99999` æˆ–æ›´å¤§å€¼è¡¨ç¤ºç»ˆèº«æœ‰æ•ˆ
   - é€‚åˆï¼šè½¯ä»¶ç»ˆèº«æˆæƒã€æ°¸ä¹…VIPä¼šå‘˜ç­‰

2. **ğŸ’¾ ä¸€æ¬¡æ€§è½¯ä»¶è´­ä¹°**
   - ä¼ ç»Ÿè½¯ä»¶é”€å”®æ¨¡å¼ï¼Œä¹°æ–­åˆ¶
   - ç”¨æˆ·æ”¯ä»˜åæ°¸ä¹…æ‹¥æœ‰è¯¥ç‰ˆæœ¬è½¯ä»¶
   - è®¾ç½® `months: 99999` è¡¨ç¤ºæ°¸ä¹…æˆæƒ

3. **ğŸ“š å•æ¬¡è¯¾ç¨‹/å†…å®¹è´­ä¹°**
   - åœ¨çº¿è¯¾ç¨‹ã€ç”µå­ä¹¦ã€æ•™ç¨‹ç­‰æ•°å­—å†…å®¹
   - è´­ä¹°åæ°¸ä¹…å¯è®¿é—®ï¼Œæ— éœ€ç»­è´¹
   - æ ¹æ®å†…å®¹ç‰¹æ€§è®¾ç½®åˆç†çš„æœ‰æ•ˆæœŸ

4. **ğŸ› ï¸ ä¸€æ¬¡æ€§æœåŠ¡è´­ä¹°**
   - è®¾è®¡æœåŠ¡ã€å’¨è¯¢æœåŠ¡ã€å®šåˆ¶å¼€å‘ç­‰
   - æœåŠ¡å®Œæˆåä¸éœ€è¦æŒç»­ä»˜è´¹
   - å¯è®¾ç½®æœåŠ¡ä¿éšœæœŸï¼Œå¦‚6ä¸ªæœˆæˆ–12ä¸ªæœˆ

5. **ğŸ« æ´»åŠ¨é—¨ç¥¨/ä¼šè®®ç¥¨**
   - ä¸€æ¬¡æ€§æ´»åŠ¨å‚ä¸æƒ
   - æ˜ç¡®çš„æ—¶é—´èŒƒå›´ï¼Œå¦‚æ´»åŠ¨æŒç»­æ—¶é—´
   - è®¾ç½®å…·ä½“çš„æœ‰æ•ˆæœˆæ•°

**é…ç½®ç¤ºä¾‹**ï¼š

```typescript
type OneTimePlan = {
  duration: { type: 'one_time'; months: number };
  // months è®¾ç½®æŒ‡å—ï¼š
  // - 99999+ï¼šç»ˆèº«æœ‰æ•ˆï¼ˆè½¯ä»¶æˆæƒã€ç»ˆèº«ä¼šå‘˜ï¼‰
  // - 12-60ï¼šé•¿æœŸæœ‰æ•ˆï¼ˆè¯¾ç¨‹ã€å†…å®¹è´­ä¹°ï¼‰
  // - 1-6ï¼šçŸ­æœŸæœ‰æ•ˆï¼ˆæœåŠ¡ã€é—¨ç¥¨ï¼‰
}

// ç®€å•æ¼”ç¤ºé…ç½®ï¼ˆå…·ä½“ç»“æ„è¯·å‚è€ƒä¸‹é¢çš„è¯¦ç»†é…ç½®ï¼‰
const oneTimePlans = {
  // ç»ˆèº«ä¼šå‘˜
  lifetime: {
    duration: { type: 'one_time', months: 99999 },
    name: 'ç»ˆèº«ä¼šå‘˜',
    description: 'ä¸€æ¬¡è´­ä¹°ï¼Œæ°¸ä¹…äº«å—æ‰€æœ‰åŠŸèƒ½'
  },
  
  // è½¯ä»¶ä¹°æ–­
  softwareLicense: {
    duration: { type: 'one_time', months: 99999 },
    name: 'è½¯ä»¶æ°¸ä¹…æˆæƒ',
    description: 'ä¹°æ–­åˆ¶è½¯ä»¶ï¼Œæ°¸ä¹…ä½¿ç”¨å½“å‰ç‰ˆæœ¬'
  },
  
  // åœ¨çº¿è¯¾ç¨‹
  course: {
    duration: { type: 'one_time', months: 24 },
    name: 'ä¸“ä¸šè¯¾ç¨‹åŒ…',
    description: 'è´­ä¹°å2å¹´å†…å¯æ— é™æ¬¡è§‚çœ‹'
  },
  
  // å’¨è¯¢æœåŠ¡
  consultation: {
    duration: { type: 'one_time', months: 6 },
    name: 'ä¸“ä¸šå’¨è¯¢æœåŠ¡',
    description: 'åŒ…å«6ä¸ªæœˆçš„åç»­æ”¯æŒæœåŠ¡'
  }
}
```

**æŠ€æœ¯å®ç°ç‰¹ç‚¹**ï¼š
- `cancelAtPeriodEnd: true` - åˆ°æœŸåè‡ªåŠ¨åœæ­¢ï¼Œä¸ä¼šç»­è´¹
- `paymentType: ONE_TIME` - æ ‡è®°ä¸ºä¸€æ¬¡æ€§æ”¯ä»˜
- å½“ `months >= 9999` æ—¶ï¼Œç³»ç»Ÿä¼šè®¾ç½®100å¹´çš„è¶…é•¿æœŸé™ï¼Œå®ç°"æ°¸ä¹…"æ•ˆæœ

#### è®¢é˜…ä»˜è´¹ (Recurring)

è®¢é˜…ä»˜è´¹æ˜¯å®šæœŸè‡ªåŠ¨ç»­è´¹çš„æ”¯ä»˜æ¨¡å¼ï¼Œç”¨æˆ·æŒ‰å‘¨æœŸï¼ˆæœˆ/å¹´ï¼‰ä»˜è´¹ï¼Œå¯æŒç»­äº«å—æœåŠ¡ç›´åˆ°ä¸»åŠ¨å–æ¶ˆã€‚

**é€‚ç”¨åœºæ™¯**ï¼š

1. **ğŸ’¼ SaaS è½¯ä»¶æœåŠ¡**
   - ä¼ä¸šç®¡ç†è½¯ä»¶ã€é¡¹ç›®åä½œå·¥å…·ç­‰
   - æŒ‰æœˆæˆ–æŒ‰å¹´è®¢é˜…ï¼ŒæŒç»­æä¾›æœåŠ¡å’Œæ›´æ–°
   - é€‚åˆï¼šCRMç³»ç»Ÿã€è®¾è®¡å·¥å…·ã€å¼€å‘å¹³å°ç­‰

2. **ğŸ“± åº”ç”¨ä¼šå‘˜æœåŠ¡**
   - ç§»åŠ¨åº”ç”¨çš„é«˜çº§åŠŸèƒ½è®¢é˜…
   - éŸ³ä¹ã€è§†é¢‘ã€é˜…è¯»ç­‰å†…å®¹å¹³å°
   - é€‚åˆï¼šæµåª’ä½“æœåŠ¡ã€æ–°é—»è®¢é˜…ã€å¥èº«åº”ç”¨ç­‰

3. **â˜ï¸ äº‘æœåŠ¡/API æœåŠ¡**
   - äº‘å­˜å‚¨ã€äº‘è®¡ç®—ã€APIè°ƒç”¨ç­‰
   - æŒ‰ä½¿ç”¨é‡æˆ–å›ºå®šå¥—é¤å®šæœŸä»˜è´¹
   - é€‚åˆï¼šäº‘ä¸»æœºã€CDNæœåŠ¡ã€ç¬¬ä¸‰æ–¹APIç­‰

4. **ğŸ“š åœ¨çº¿æ•™è‚²/åŸ¹è®­**
   - æŒç»­æ›´æ–°çš„è¯¾ç¨‹å†…å®¹
   - å®šæœŸç›´æ’­è¯¾ç¨‹ã€ç­”ç–‘æœåŠ¡
   - é€‚åˆï¼šæŠ€èƒ½åŸ¹è®­ã€è¯­è¨€å­¦ä¹ ã€èŒä¸šæ•™è‚²ç­‰

5. **ğŸ® æ¸¸æˆ/å¨±ä¹è®¢é˜…**
   - æ¸¸æˆä¼šå‘˜ã€ç‰¹æƒåŠŸèƒ½
   - æŒç»­çš„å†…å®¹æ›´æ–°å’Œç‰¹æ®Šç¦åˆ©
   - é€‚åˆï¼šæ¸¸æˆé€šè¡Œè¯ã€ä¼šå‘˜ç‰¹æƒã€è™šæ‹Ÿå•†å“ç­‰

**é…ç½®ç¤ºä¾‹**ï¼š

```typescript
type RecurringPlan = {
  duration: { type: 'recurring'; months: number };
  stripePriceId?: string;    // Stripe ä»·æ ¼ ID
  creemProductId?: string;   // Creem äº§å“ ID
  // months è®¾ç½®æŒ‡å—ï¼š
  // - 1ï¼šæœˆåº¦è®¢é˜…ï¼ˆæœ€å¸¸è§ï¼‰
  // - 3ï¼šå­£åº¦è®¢é˜…ï¼ˆæŠ˜æ‰£ä¼˜æƒ ï¼‰
  // - 6ï¼šåŠå¹´è®¢é˜…ï¼ˆæ›´å¤šä¼˜æƒ ï¼‰
  // - 12ï¼šå¹´åº¦è®¢é˜…ï¼ˆæœ€å¤§ä¼˜æƒ ï¼‰
}

// ç®€å•æ¼”ç¤ºé…ç½®ï¼ˆå…·ä½“ç»“æ„è¯·å‚è€ƒä¸‹é¢çš„è¯¦ç»†é…ç½®ï¼‰
const recurringPlans = {
  // æœˆåº¦åŸºç¡€ç‰ˆ
  monthlyBasic: {
    duration: { type: 'recurring', months: 1 },
    name: 'åŸºç¡€ç‰ˆæœˆåº¦è®¢é˜…',
    description: 'æ¯æœˆè‡ªåŠ¨ç»­è´¹ï¼Œéšæ—¶å¯å–æ¶ˆ'
  },
  
  // å¹´åº¦ä¸“ä¸šç‰ˆ
  yearlyPro: {
    duration: { type: 'recurring', months: 12 },
    name: 'ä¸“ä¸šç‰ˆå¹´åº¦è®¢é˜…',
    description: 'å¹´ä»˜äº«å—2ä¸ªæœˆå…è´¹ï¼ŒåŠŸèƒ½æ›´ä¸°å¯Œ'
  },
  
  // å­£åº¦ä¼ä¸šç‰ˆ
  quarterlyEnterprise: {
    duration: { type: 'recurring', months: 3 },
    name: 'ä¼ä¸šç‰ˆå­£åº¦è®¢é˜…',
    description: 'ä¸“ä¸ºå›¢é˜Ÿè®¾è®¡ï¼ŒåŒ…å«åä½œå’Œç®¡ç†åŠŸèƒ½'
  }
}
```

**æŠ€æœ¯å®ç°ç‰¹ç‚¹**ï¼š
- `cancelAtPeriodEnd: false` - è‡ªåŠ¨ç»­è´¹ï¼Œç›´åˆ°ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆ
- `paymentType: RECURRING` - æ ‡è®°ä¸ºå¾ªç¯è®¢é˜…
- æ”¯æŒå‡çº§/é™çº§ï¼šç”¨æˆ·å¯åœ¨è®¢é˜…æœŸé—´å˜æ›´è®¡åˆ’
- è‡ªåŠ¨ç»­è´¹ç®¡ç†ï¼šç³»ç»Ÿå¤„ç†å‘¨æœŸæ€§ä»˜è´¹å’Œå¤±è´¥é‡è¯•

### ğŸ› ï¸ è®¡åˆ’é…ç½®ç¤ºä¾‹

ä»¥ä¸‹æ˜¯åŸºäº `config.ts` çš„å®é™…é…ç½®ç¤ºä¾‹ï¼š

#### 1. å¾®ä¿¡æ”¯ä»˜æ–¹æ¡ˆ (å•æ¬¡ä»˜è´¹)

```typescript
monthlyWechat: {
  provider: 'wechat',           // æŒ‡å®šæ”¯ä»˜æä¾›å•†
  id: 'monthlyWechat',          // æ¯ç§æ”¯ä»˜æ–¹æ¡ˆéœ€è¦åˆ†é…ä¸€ä¸ªä¸åŒçš„ id
  amount: 0.01,                 // é‡‘é¢ (åˆ†)
  currency: 'CNY',              // å¸ç§
  duration: {
    months: 1,
    type: 'one_time'            // å¾®ä¿¡æ”¯ä»˜åªæ”¯æŒå•æ¬¡ä»˜è´¹
  },
  i18n: {
    'en': {
      name: 'Monthly Plan',
      description: 'Perfect for short-term projects',
      duration: 'month',
      features: ['All premium features', 'Priority support']
    },
    'zh-CN': {
      name: 'æœˆåº¦è®¢é˜…wechat',
      description: 'æ¯æœˆè®¢é˜…ï¼Œçµæ´»ç®¡ç†',
      duration: 'æœˆ',
      features: ['æ‰€æœ‰é«˜çº§åŠŸèƒ½', 'ä¼˜å…ˆæ”¯æŒ']
    }
  }
}
```

#### 2. Stripe è®¢é˜…æ–¹æ¡ˆ

```typescript
monthly: {
  provider: 'stripe',
  id: 'monthly',
  // å½“ä½¿ç”¨ Stripe æ”¯ä»˜æ—¶ï¼Œè®¢é˜…çš„æ—¶é•¿å’Œä»·æ ¼å°†ç”± stripePriceId å†³å®š
  // è¿™é‡Œçš„ duration å’Œ amount ä»…ç”¨äºæ˜¾ç¤ºå’Œè®¡ç®—ï¼Œå®é™…è®¢é˜…å‘¨æœŸå’Œä»·æ ¼ä»¥ Stripe åå°é…ç½®ä¸ºå‡†
  amount: 10,                   // æ˜¾ç¤ºé‡‘é¢
  currency: 'CNY',
  duration: {
    months: 1,
    type: 'recurring'           // æ”¯æŒè®¢é˜…æ¨¡å¼
  },
  stripePriceId: 'price_1RL2GgDjHLfDWeHDBHjoZaap', // Stripe ä»·æ ¼ ID
  recommended: true,            // æ¨èæ ‡è®°
  i18n: {
    'en': {
      name: 'Monthly Plan',
      description: 'Perfect for short-term projects',
      duration: 'month',
      features: ['All premium features', 'Priority support']
    },
    'zh-CN': {
      name: 'æœˆåº¦è®¢é˜…',
      description: 'æ¯æœˆè®¢é˜…ï¼Œçµæ´»ç®¡ç†',
      duration: 'æœˆ',
      features: ['æ‰€æœ‰é«˜çº§åŠŸèƒ½', 'ä¼˜å…ˆæ”¯æŒ']
    }
  }
}
```

#### 3. Stripe ç»ˆèº«æ–¹æ¡ˆ (å•æ¬¡ä»˜è´¹)

```typescript
lifetime: {
  provider: 'stripe',
  id: 'lifetime',
  amount: 999,
  currency: 'CNY',
  recommended: true,            // è®¾ä¸ºæ¨è
  duration: {
    months: 999999,             // è¡¨ç¤ºç»ˆèº« plan.duration.months >= 9999; ä¼šè¢«å®šä¹‰ä¸ºç»ˆç”Ÿä¼šå‘˜
    type: 'one_time'           // å•æ¬¡ä»˜è´¹
  },
  stripePriceId: 'price_1RL2IcDjHLfDWeHDMCmobkzb',
  i18n: {
    'en': {
      name: 'Lifetime',
      description: 'One-time payment, lifetime access',
      duration: 'lifetime',
      features: ['All premium features', 'Priority support', 'Free lifetime updates']
    },
    'zh-CN': {
      name: 'ç»ˆèº«ä¼šå‘˜',
      description: 'ä¸€æ¬¡ä»˜è´¹ï¼Œæ°¸ä¹…ä½¿ç”¨',
      duration: 'ç»ˆèº«',
      features: ['æ‰€æœ‰é«˜çº§åŠŸèƒ½', 'ä¼˜å…ˆæ”¯æŒ', 'ç»ˆèº«å…è´¹æ›´æ–°']
    }
  }
}
```

#### 4. Creem è®¢é˜…æ–¹æ¡ˆ

```typescript
monthlyCreem: {
  provider: 'creem',
  id: 'monthlyCreem',
  amount: 10,
  currency: 'USD', 
  duration: {
    months: 1,
    type: 'recurring'
  },
  creemProductId: 'prod_1M1c4ktVmvLgrNtpVB9oQf', // Creem äº§å“ ID
  i18n: {
    'en': {
      name: 'Monthly Plan (Creem)',
      description: 'Perfect for short-term projects via Creem',
      duration: 'month',
      features: ['All premium features', 'Priority support']
    },
    'zh-CN': {
      name: 'æœˆåº¦è®¢é˜… (Creem)',
      description: 'æ¯æœˆè®¢é˜…ï¼Œé€šè¿‡Creemæ”¯ä»˜',
      duration: 'æœˆ',
      features: ['æ‰€æœ‰é«˜çº§åŠŸèƒ½', 'ä¼˜å…ˆæ”¯æŒ']
    }
  }
}
```

### ğŸ”— è·å–ä»·æ ¼ ID

#### Stripe ä»·æ ¼ ID
1. ç™»å½• [Stripe Dashboard](https://dashboard.stripe.com/)
2. å‰å¾€ "äº§å“" â†’ "äº§å“ç›®å½•"
3. åˆ›å»ºäº§å“å¹¶è®¾ç½®ä»·æ ¼
4. å¤åˆ¶ä»·æ ¼ ID (ä»¥ `price_` å¼€å¤´)

#### Creem äº§å“ ID  
1. ç™»å½• Creem Dashboard
2. åˆ›å»ºäº§å“å¹¶é…ç½®ä»·æ ¼


### âš™ï¸ å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| `id` | string | âœ… | è®¡åˆ’å”¯ä¸€æ ‡è¯†ç¬¦ |
| `provider` | string | âœ… | æ”¯ä»˜æä¾›å•† (`stripe`, `wechat`, `creem`) |
| `amount` | number | âœ… | æ˜¾ç¤ºé‡‘é¢ |
| `currency` | string | âœ… | å¸ç§ä»£ç  |
| `duration.type` | string | âœ… | `one_time` æˆ– `recurring` |
| `duration.months` | number | âœ… | æ—¶é•¿ï¼ˆæœˆæ•°ï¼‰ |
| `recommended` | boolean | âŒ | æ˜¯å¦æ¨è |
| `stripePriceId` | string | âŒ | Stripe ä»·æ ¼ ID (Stripe å¿…éœ€) |
| `creemProductId` | string | âŒ | Creem äº§å“ ID (Creem å¿…éœ€) |
| `i18n` | object | âœ… | å›½é™…åŒ–é…ç½® |
| `i18n.{locale}.name` | string | âœ… | è®¡åˆ’åç§° |
| `i18n.{locale}.description` | string | âœ… | è®¡åˆ’æè¿° |
| `i18n.{locale}.duration` | string | âœ… | æ—¶é•¿æ˜¾ç¤ºæ–‡æœ¬ |
| `i18n.{locale}.features` | string[] | âœ… | åŠŸèƒ½åˆ—è¡¨ |

### ğŸŒ å›½é™…åŒ–é…ç½®

æ¯ä¸ªè®¡åˆ’éƒ½éœ€è¦é…ç½®å¤šè¯­è¨€æ”¯æŒï¼š

```typescript
i18n: {
  'en': {                    // è‹±æ–‡
    name: 'Monthly Plan',
    description: 'Perfect for short-term projects', 
    duration: 'month',
    features: ['All premium features', 'Priority support']
  },
  'zh-CN': {                 // ç®€ä½“ä¸­æ–‡
    name: 'æœˆåº¦è®¢é˜…',
    description: 'æ¯æœˆè®¢é˜…ï¼Œçµæ´»ç®¡ç†',
    duration: 'æœˆ', 
    features: ['æ‰€æœ‰é«˜çº§åŠŸèƒ½', 'ä¼˜å…ˆæ”¯æŒ']
  }
}
```


## ğŸ§ª æµ‹è¯•é…ç½®

### æµ‹è¯•ç¯å¢ƒè®¾ç½®

åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œå¯ä»¥ä½¿ç”¨æµ‹è¯•å¯†é’¥è¿›è¡Œæ”¯ä»˜æµ‹è¯•ï¼š

#### Stripe æµ‹è¯•æ¨¡å¼

```env
# ä½¿ç”¨ test å¯†é’¥
STRIPE_SECRET_KEY=sk_test_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
STRIPE_PUBLIC_KEY=pk_test_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
STRIPE_WEBHOOK_SECRET=whsec_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

æµ‹è¯•å¡å·ï¼š
- **æˆåŠŸæ”¯ä»˜**: `4242424242424242`
- **å¤±è´¥æ”¯ä»˜**: `4000000000000002`  
- **éœ€è¦éªŒè¯**: `4000002500003155`

#### å¾®ä¿¡æ”¯ä»˜æµ‹è¯•

å¾®ä¿¡æ”¯ä»˜æ²¡æœ‰æµ‹è¯•æ²™ç›’ç¯å¢ƒï¼Œå¯ä»¥ä½¿ç”¨å°é‡‘é¢ç›´æ¥è¿›è¡Œæµ‹è¯• - æ¯”å¦‚ä¸€ä¸ªè®¢å• 0.01 å…ƒã€‚

#### Creem æµ‹è¯•æ¨¡å¼

```env
# ä½¿ç”¨æµ‹è¯•ç¯å¢ƒ
CREEM_SERVER_URL=https://test-api.creem.io
CREEM_API_KEY=creem_test_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

### æœ¬åœ°å¼€å‘æµ‹è¯•

> ğŸ’¡ **é‡è¦æç¤º**ï¼šæœ¬åœ°å¼€å‘æ—¶æ¨èä½¿ç”¨ä»¥ä¸‹æ–¹å¼æµ‹è¯• webhookï¼Œæ— éœ€å…ˆåœ¨ç”Ÿäº§ç¯å¢ƒé…ç½® webhook ç«¯ç‚¹ã€‚

æˆ‘ä»¬éœ€è¦ä½¿ç”¨çœŸå®çš„åŸŸåæ¥æ¥æ”¶ webhook çš„æ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦å°†æœ¬åœ°æœåŠ¡æ˜ å°„åˆ°çœŸå®åŸŸåä¸Šã€‚

* **Stripe**ï¼šä½¿ç”¨ Stripe CLIï¼ˆæ¨èï¼‰ï¼Œæ— éœ€å†…ç½‘ç©¿é€
* **å¾®ä¿¡æ”¯ä»˜ å’Œ Creem**ï¼šéœ€è¦ä½¿ç”¨å†…ç½‘ç©¿é€å·¥å…·

1. **å¯åŠ¨æœ¬åœ°éš§é“ é’ˆå¯¹å¾®ä¿¡æ”¯ä»˜å’Œ Creem** (ç”¨äºæ¥æ”¶ Webhook)ï¼Œè¿™é‡Œå¯ä»¥é€‰æ‹© ngrokï¼Œcloudflare tunnel ç­‰ä½ å–œæ¬¢çš„å†…ç½‘ç©¿é€å·¥å…·ã€‚

* [ngrok æ–‡æ¡£åœ°å€](https://ngrok.com/docs/getting-started/)
* [cloudflare æ–‡æ¡£åœ°å€](https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/)

```bash
# ä½¿ç”¨ ngrok åˆ›å»ºå…¬ç½‘éš§é“
npx ngrok http 7001
```

å°†éš§é“åœ°å€é…ç½®åˆ°å„æ”¯ä»˜å¹³å°ï¼š
- å¾®ä¿¡æ”¯ä»˜: `https://abc123.ngrok.io/api/payment/webhook/wechat`
- Creem: `https://abc123.ngrok.io/api/payment/webhook/creem`

**Stripe Webhook æµ‹è¯•ï¼ˆä¸¤ç§æ–¹æ¡ˆï¼‰**

Stripe æ”¯æŒä¸¤ç§æœ¬åœ° webhook æµ‹è¯•æ–¹å¼ï¼š

**æ–¹æ¡ˆä¸€ï¼šStripe CLIï¼ˆæ¨èï¼‰**

æ–‡æ¡£åœ°å€ï¼š[https://docs.stripe.com/stripe-cli](https://docs.stripe.com/stripe-cli)

```bash
# 1. å®‰è£… Stripe CLI
# macOS
brew install stripe/stripe-cli/stripe

# Windows
scoop bucket add stripe https://github.com/stripe/scoop-stripe-cli.git
scoop install stripe

# 2. ç™»å½•åˆ° Stripe è´¦æˆ·
stripe login

# 3. å¯åŠ¨ webhook è½¬å‘
stripe listen --forward-to localhost:7001/api/payment/webhook/stripe

# 4. CLI ä¼šæ˜¾ç¤º webhook ç­¾åå¯†é’¥ï¼Œå¤åˆ¶åˆ°ç¯å¢ƒå˜é‡
# è¾“å‡ºç¤ºä¾‹ï¼šwhsec_1234567890abcdef...
```

**ä¼˜åŠ¿**ï¼š
- âœ… æ— éœ€å¤–ç½‘è®¿é—®ï¼Œå®Œå…¨æœ¬åœ°åŒ–
- âœ… å®æ—¶æ¥æ”¶çœŸå® webhook äº‹ä»¶
- âœ… è‡ªåŠ¨å¤„ç†ç­¾åéªŒè¯
- âœ… å¯æŸ¥çœ‹è¯¦ç»†çš„äº‹ä»¶æ—¥å¿—

**æ–¹æ¡ˆäºŒï¼šngrok + Stripe Dashboardï¼ˆå¤‡é€‰ï¼‰**

å½“ Stripe CLI ä¸å¯ç”¨æ—¶çš„å¤‡é€‰æ–¹æ¡ˆï¼š

```bash
# 1. å¯åŠ¨ ngrok éš§é“
ngrok http 7001

# 2. å¤åˆ¶ ngrok æä¾›çš„ https åœ°å€
# ç¤ºä¾‹ï¼šhttps://abc123.ngrok.io

# 3. åœ¨ Stripe Dashboard ä¸­é…ç½® webhook ç«¯ç‚¹
# åœ°å€ï¼šhttps://abc123.ngrok.io/api/payment/webhook/stripe
# é€‰æ‹©éœ€è¦çš„äº‹ä»¶ç±»å‹ï¼š
# - checkout.session.completed
# - customer.subscription.updated
# - customer.subscription.deleted
```

**é…ç½®ç¯å¢ƒå˜é‡**ï¼š
```bash
# .env.local
STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret_here
```

**æµ‹è¯•éªŒè¯**ï¼š

**1. åŸºç¡€äº‹ä»¶è§¦å‘**ï¼š
```bash
# ç›‘æ§ webhook äº‹ä»¶ï¼ˆä½¿ç”¨ Stripe CLI æ—¶ï¼‰
stripe listen --forward-to localhost:7001/api/payment/webhook/stripe --events checkout.session.completed,customer.subscription.updated

# å‘é€é¢„å®šä¹‰çš„æµ‹è¯•äº‹ä»¶
stripe trigger checkout.session.completed
stripe trigger customer.subscription.updated
stripe trigger customer.subscription.deleted
```

**2. trigger å‘½ä»¤è¯´æ˜**ï¼š

`stripe trigger` ä¼šç”Ÿæˆ**é¢„å®šä¹‰çš„æ¨¡æ‹Ÿæ•°æ®**ï¼Œä¸èƒ½è‡ªå®šä¹‰å…·ä½“å†…å®¹ï¼Œä½†ä¼šè§¦å‘çœŸå®çš„ webhook äº‹ä»¶æµç¨‹ï¼š

```bash
# æŸ¥çœ‹å¯ç”¨çš„è§¦å‘å™¨äº‹ä»¶
stripe trigger --help

# è§¦å‘è®¢é˜…ç›¸å…³äº‹ä»¶
stripe trigger checkout.session.completed  # æ¨¡æ‹Ÿæ”¯ä»˜å®Œæˆ
stripe trigger invoice.payment_succeeded    # æ¨¡æ‹Ÿå‘ç¥¨æ”¯ä»˜æˆåŠŸ
stripe trigger customer.subscription.created # æ¨¡æ‹Ÿè®¢é˜…åˆ›å»º
```

**ç”Ÿæˆçš„æ•°æ®ç‰¹ç‚¹**ï¼š
- âœ… æ•°æ®ç»“æ„ä¸çœŸå®äº‹ä»¶å®Œå…¨ä¸€è‡´
- âœ… åŒ…å«æ‰€æœ‰å¿…éœ€çš„å­—æ®µå’Œå…³ç³»
- âŒ æ•°æ®å†…å®¹æ˜¯å›ºå®šçš„æµ‹è¯•å€¼
- âŒ æ— æ³•æŒ‡å®šç‰¹å®šçš„ç”¨æˆ·IDæˆ–è®¢å•ä¿¡æ¯

**3. è‡ªå®šä¹‰æ•°æ®æµ‹è¯•**ï¼š

å¦‚éœ€æµ‹è¯•ç‰¹å®šæ•°æ®åœºæ™¯ï¼Œå¯ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š

**æ–¹æ³•ä¸€ï¼šStripe Dashboardæµ‹è¯•**
```bash
# 1. åœ¨ Stripe Dashboard ä¸­åˆ›å»ºçœŸå®çš„æ”¯ä»˜ä¼šè¯
# 2. ä½¿ç”¨æµ‹è¯•å¡å·å®Œæˆæ”¯ä»˜ï¼š4242 4242 4242 4242
# 3. è§‚å¯Ÿæœ¬åœ°åº”ç”¨æ¥æ”¶åˆ°çš„çœŸå® webhook æ•°æ®
```

**æ–¹æ³•äºŒï¼šæ‰‹åŠ¨å‘é€è‡ªå®šä¹‰ webhook**
```bash
# å‘é€è‡ªå®šä¹‰çš„ webhook æ•°æ®åˆ°æœ¬åœ°ç«¯ç‚¹
curl -X POST http://localhost:7001/api/payment/webhook/stripe \
  -H "Content-Type: application/json" \
  -H "Stripe-Signature: YOUR_TEST_SIGNATURE" \
  -d '{
    "id": "evt_test_webhook",
    "object": "event",
    "type": "checkout.session.completed",
    "data": {
      "object": {
        "id": "cs_test_custom_session_id",
        "mode": "subscription",
        "customer": "cus_test_customer",
        "metadata": {
          "planId": "your_plan_id",
          "userId": "your_user_id",
          "orderId": "your_order_id"
        }
      }
    }
  }'
```

**4. å®é™…æµ‹è¯•å»ºè®®**ï¼š

```bash
# æ­¥éª¤1ï¼šå¯åŠ¨ç›‘å¬
stripe listen --forward-to localhost:7001/api/payment/webhook/stripe

# æ­¥éª¤2ï¼šå¯åŠ¨æœ¬åœ°åº”ç”¨
pnpm run dev

# æ­¥éª¤3ï¼šè®¿é—®æ”¯ä»˜é¡µé¢ï¼Œä½¿ç”¨æµ‹è¯•å¡å®ŒæˆçœŸå®æ”¯ä»˜æµç¨‹
open http://localhost:7001/pricing

# æ­¥éª¤4ï¼šè§‚å¯Ÿæ§åˆ¶å°è¾“å‡ºï¼ŒéªŒè¯ webhook å¤„ç†é€»è¾‘
```

**æµ‹è¯•å¡å·**ï¼š
- `4242 4242 4242 4242` - æˆåŠŸæ”¯ä»˜
- `4000 0000 0000 0002` - æ”¯ä»˜å¤±è´¥  
- `4000 0000 0000 9995` - èµ„é‡‘ä¸è¶³

3. **æµ‹è¯•æ”¯ä»˜æµç¨‹**

```bash
# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
pnpm run dev

# è®¿é—®å®šä»·é¡µé¢
open http://localhost:7001/pricing

# é€‰æ‹©è®¡åˆ’è¿›è¡Œæµ‹è¯•æ”¯ä»˜
```

## ğŸ”„ æ”¯ä»˜æµç¨‹

### æ”¯ä»˜å¤„ç†æµç¨‹

1. **ç”¨æˆ·é€‰æ‹©è®¡åˆ’** â†’ 2. **åˆ›å»ºè®¢å•** â†’ 3. **è·³è½¬æ”¯ä»˜** â†’ 4. **å¤„ç†å›è°ƒ** â†’ 5. **æ›´æ–°çŠ¶æ€**

### API ç«¯ç‚¹

é¡¹ç›®æä¾›ä»¥ä¸‹æ”¯ä»˜ç›¸å…³çš„ API ç«¯ç‚¹ï¼š

```typescript
// å‘èµ·æ”¯ä»˜
POST /api/payment/initiate
{
  "planId": "monthly",
  "provider": "stripe"
}

// æ”¯ä»˜çŠ¶æ€æŸ¥è¯¢  
GET /api/payment/query/:orderId

// æ”¯ä»˜å›è°ƒå¤„ç†
POST /api/payment/webhook/:provider

// å–æ¶ˆæ”¯ä»˜
POST /api/payment/cancel/:orderId
```

## ğŸ“š å‚è€ƒæ–‡æ¡£

### å¾®ä¿¡æ”¯ä»˜
- [å¾®ä¿¡æ”¯ä»˜å¼€å‘æ–‡æ¡£](https://pay.weixin.qq.com/wiki/doc/api/index.html)
- [å¾®ä¿¡æ”¯ä»˜å…¬é’¥éªŒè¯æŒ‡å¼•](https://pay.weixin.qq.com/doc/v3/merchant/4013053249)
- [APIv3ç­¾åå’ŒéªŒç­¾æ€»è¿°](https://pay.weixin.qq.com/doc/v3/merchant/4012365342)

### å…¶ä»–æ”¯ä»˜å¹³å°
- [Stripe å¼€å‘æ–‡æ¡£](https://stripe.com/docs)
- [Creem API æ–‡æ¡£](https://docs.creem.io/)


