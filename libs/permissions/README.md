# TinyShip æƒé™æ§åˆ¶ç³»ç»Ÿ

è¿™æ˜¯ä¸€ä¸ªåŸºäº CASL çš„æƒé™æ§åˆ¶ç³»ç»Ÿï¼Œç”¨äº TinyShip åº”ç”¨ä¸­æ§åˆ¶ç”¨æˆ·å¯¹ä¸åŒèµ„æºçš„è®¿é—®æƒé™ã€‚æ”¯æŒ Next.js å’Œ Nuxt.js åº”ç”¨ã€‚

## ğŸ—ï¸ è®¾è®¡æ€æƒ³

æƒé™ç³»ç»ŸåŸºäºä»¥ä¸‹æ ¸å¿ƒæ¦‚å¿µï¼š

1. **è§’è‰² (Roles)**: å®šä¹‰ç”¨æˆ·åœ¨ç³»ç»Ÿä¸­çš„èº«ä»½
   - `normal`: æ™®é€šç”¨æˆ·ï¼ˆé»˜è®¤è§’è‰²ï¼‰*ã€å½“å‰æœªä½¿ç”¨ï¼Œä»…ä½œä¸ºé»˜è®¤å€¼ã€‘*
   - `vip`: VIPç”¨æˆ·ï¼ˆä»˜è´¹ç”¨æˆ·ï¼‰*ã€å½“å‰æœªä½¿ç”¨ï¼Œé¢„ç•™æ‰©å±•ã€‘*
   - `admin`: ç®¡ç†å‘˜ï¼ˆè¶…çº§æƒé™ï¼‰*ã€âœ… å½“å‰ä½¿ç”¨ï¼šè®¿é—®ç®¡ç†åå°ã€‘*
   - `user`: æ ‡å‡†ç”¨æˆ·*ã€âœ… å½“å‰å®é™…ä½¿ç”¨ï¼šæ•°æ®åº“é»˜è®¤è§’è‰²ã€‘*

2. **èµ„æº (Subjects)**: å®šä¹‰ç³»ç»Ÿä¸­å¯è¢«æ“ä½œçš„å®ä½“
   - `user`: ç”¨æˆ·ç®¡ç†*ã€é¢„ç•™æ‰©å±•ã€‘*
   - `project`: é¡¹ç›®ç®¡ç†*ã€é¢„ç•™æ‰©å±•ã€‘*
   - `subscription`: è®¢é˜…ç®¡ç†*ã€é¢„ç•™æ‰©å±•ã€‘*
   - `report`: æŠ¥å‘ŠåŠŸèƒ½*ã€é¢„ç•™æ‰©å±•ã€‘*
   - `setting`: ç³»ç»Ÿè®¾ç½®*ã€é¢„ç•™æ‰©å±•ã€‘*
   - `all`: æ‰€æœ‰èµ„æº*ã€âœ… å½“å‰ä½¿ç”¨ï¼šç®¡ç†å‘˜è®¿é—®æ§åˆ¶ã€‘*

3. **æ“ä½œ (Actions)**: å®šä¹‰ç”¨æˆ·å¯å¯¹èµ„æºæ‰§è¡Œçš„åŠ¨ä½œ
   - `create`: åˆ›å»ºèµ„æº*ã€é¢„ç•™æ‰©å±•ã€‘*
   - `read`: è¯»å–èµ„æº*ã€é¢„ç•™æ‰©å±•ã€‘*
   - `update`: æ›´æ–°èµ„æº*ã€é¢„ç•™æ‰©å±•ã€‘*
   - `delete`: åˆ é™¤èµ„æº*ã€é¢„ç•™æ‰©å±•ã€‘*
   - `manage`: ç®¡ç†æ‰€æœ‰æ“ä½œ*ã€âœ… å½“å‰ä½¿ç”¨ï¼šç®¡ç†å‘˜æƒé™æ£€æŸ¥ã€‘*

4. **è§„åˆ™ (Rules)**: é€šè¿‡ CASL å®šä¹‰è§’è‰²ã€èµ„æºå’Œæ“ä½œä¹‹é—´çš„å…³ç³»

## ğŸš¨ å½“å‰å®é™…ä½¿ç”¨æƒ…å†µ

**ç›®å‰ç³»ç»Ÿä¸­ä¸»è¦ä½¿ç”¨çš„æƒé™æ§åˆ¶åœºæ™¯ï¼š**

1. **ç®¡ç†åå°è®¿é—®æ§åˆ¶**
   - è·¯ç”±: `/admin/*` (Next.js) å’Œ `/admin/*` (Nuxt.js) 
   - æƒé™æ£€æŸ¥: `can(user, Action.MANAGE, Subject.ALL)`
   - åªæœ‰ `admin` è§’è‰²ç”¨æˆ·å¯ä»¥è®¿é—®

2. **ç”¨æˆ·è§’è‰²ç³»ç»Ÿ**
   - æ•°æ®åº“è§’è‰²: `admin` | `user` (å®šä¹‰åœ¨ `libs/database/constants.ts`)
   - æƒé™ç³»ç»Ÿè§’è‰²æ˜ å°„: `admin` â†’ `Role.ADMIN`, å…¶ä»– â†’ `Role.NORMAL`

3. **è®¢é˜…åŠŸèƒ½æƒé™**
   - éƒ¨åˆ†åŠŸèƒ½éœ€è¦æœ‰æ•ˆè®¢é˜…æ‰èƒ½è®¿é—®ï¼ˆå¦‚ premium-features é¡µé¢ï¼‰
   - ä½¿ç”¨è®¢é˜…ä¸­é—´ä»¶è€Œéæƒé™ç³»ç»Ÿè¿›è¡Œæ§åˆ¶

**å…¶ä»–è§’è‰²å’Œèµ„æºç›®å‰ä¸ºé¢„ç•™æ‰©å±•ï¼Œå¯æ ¹æ®ä¸šåŠ¡éœ€æ±‚è¿›è¡Œé…ç½®ã€‚**

## ğŸ“¦ ç³»ç»Ÿç»„ä»¶

æƒé™ç³»ç»ŸåŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š

- **types.ts**: è§’è‰²ã€èµ„æºå’Œæ“ä½œçš„ç±»å‹å®šä¹‰
- **abilities.ts**: åŸºäº CASL çš„æƒé™è§„åˆ™å®šä¹‰
- **utils.ts**: æ ¸å¿ƒæƒé™æ£€æŸ¥å‡½æ•°ï¼ˆ`can`ã€`createAppUser`ï¼‰
- **Vue Composables**: Nuxt.js åº”ç”¨çš„æƒé™æ£€æŸ¥ç»„åˆå‡½æ•°
- **PermissionGuard**: Vue ç»„ä»¶çº§æƒé™ä¿æŠ¤

## ğŸ’¡ åŸºæœ¬ä½¿ç”¨

### å½“å‰ç³»ç»Ÿå®é™…ä½¿ç”¨ç¤ºä¾‹

```typescript
import { can, Action, Subject, createAppUser } from '@libs/permissions';

// å½“å‰ä¸»è¦ä½¿ç”¨åœºæ™¯ï¼šç®¡ç†åå°è®¿é—®æ§åˆ¶
const user = createAppUser(sessionUser); // ä»sessionç”¨æˆ·åˆ›å»ºAppUser
const canAccessAdmin = can(user, Action.MANAGE, Subject.ALL); // åªæœ‰adminè§’è‰²è¿”å›true

// åœ¨ä¸­é—´ä»¶ä¸­çš„å®é™…ä½¿ç”¨
const hasPermission = can(appUser, Action.MANAGE, Subject.ALL);
if (!hasPermission) {
  // æ‹’ç»è®¿é—®ç®¡ç†åå°
  return Response.json({ error: 'æƒé™ä¸è¶³' }, { status: 403 });
}
```

### æ‰©å±•æƒé™æ£€æŸ¥ç¤ºä¾‹

```typescript
// ä»¥ä¸‹ä¸ºæ‰©å±•ç”¨æ³•ç¤ºä¾‹ï¼Œå½“å‰æœªå¯ç”¨
const hasPermission = can(user, Action.UPDATE, Subject.PROJECT);
const canEditProfile = can(user, Action.UPDATE, Subject.USER, { id: user.id });
```

### å®é™…åº”ç”¨ä¸­çš„æƒé™æ£€æŸ¥

```typescript
// å½“å‰ç³»ç»Ÿçš„å®é™…ç”¨æ³•ï¼ˆNext.js ä¸­é—´ä»¶ï¼‰
import { can, Action, Subject, createAppUser } from '@libs/permissions';

// åœ¨è·¯ç”±ä¸­é—´ä»¶ä¸­æ£€æŸ¥ç®¡ç†å‘˜æƒé™
const appUser = createAppUser(session?.user);
const hasPermission = can(appUser, Action.MANAGE, Subject.ALL);

if (!hasPermission) {
  return Response.json({ error: 'æƒé™ä¸è¶³' }, { status: 403 });
}

// Nuxt.js ä¸­é—´ä»¶ä¸­çš„ä½¿ç”¨
const appUser = createAppUser(user);
const hasPermission = can(appUser, Action.MANAGE, Subject.ALL);

if (!hasPermission) {
  throw createError({
    statusCode: 403,
    statusMessage: 'æƒé™ä¸è¶³'
  });
}
```


## ğŸ§ª æƒé™è§„åˆ™

### å½“å‰å®é™…æƒé™çŸ©é˜µ

| è§’è‰² | Admin åå°è®¿é—® | å…¶ä»–èµ„æº | è¯´æ˜ |
|------|---------------|----------|------|
| **admin** | âœ… å®Œå…¨è®¿é—® | *é¢„ç•™æ‰©å±•* | ç®¡ç†å‘˜å¯è®¿é—®æ‰€æœ‰ç®¡ç†åŠŸèƒ½ |
| **user** (é»˜è®¤) | âŒ æ‹’ç»è®¿é—® | *é¢„ç•™æ‰©å±•* | æ™®é€šç”¨æˆ·æ— ç®¡ç†æƒé™ |

### æ‰©å±•æƒé™çŸ©é˜µï¼ˆæ¼”ç¤ºç”¨ï¼‰

*ä»¥ä¸‹ä¸ºå®Œæ•´æƒé™ç³»ç»Ÿçš„æ¼”ç¤ºé…ç½®ï¼Œå¯æ ¹æ®ä¸šåŠ¡éœ€æ±‚å¯ç”¨ï¼š*

| è§’è‰²/æ“ä½œ | User | Project | Subscription | Report | Setting |
|----------|------|---------|--------------|--------|---------|
| **NORMAL** | R, U (è‡ªå·±) | R, C | - | R | - |
| **VIP** | R, U (è‡ªå·±) | R, C, U | R | R, C | R |
| **ADMIN** | å…¨éƒ¨æƒé™ | å…¨éƒ¨æƒé™ | å…¨éƒ¨æƒé™ | å…¨éƒ¨æƒé™ | å…¨éƒ¨æƒé™ |

*æ³¨ï¼šR=è¯»å–, C=åˆ›å»º, U=æ›´æ–°, D=åˆ é™¤*

### å½“å‰ä½¿ç”¨çš„æƒé™é€»è¾‘

```typescript
// å½“å‰å®é™…ä½¿ç”¨çš„æƒé™æ£€æŸ¥
const user = createAppUser(sessionUser);

// ç®¡ç†åå°è®¿é—®æ§åˆ¶ï¼ˆâœ… å½“å‰ä½¿ç”¨ï¼‰
can(user, Action.MANAGE, Subject.ALL) // åªæœ‰ admin è§’è‰²è¿”å› true

// è§’è‰²æ£€æŸ¥ï¼ˆâœ… å½“å‰ä½¿ç”¨ï¼‰
const isAdmin = user.role === 'admin';
const isVip = userValue?.role === 'vip' || userValue?.role === 'admin';
```

### æ‰©å±•æƒé™é€»è¾‘ï¼ˆæ¼”ç¤ºç”¨ï¼‰

*ä»¥ä¸‹ä¸ºå®Œæ•´æƒé™ç³»ç»Ÿçš„æ¼”ç¤ºé…ç½®ï¼š*

```typescript
// ç”¨æˆ·åªèƒ½ç¼–è¾‘è‡ªå·±çš„ä¿¡æ¯ï¼ˆé¢„ç•™æ‰©å±•ï¼‰
can(user, Action.UPDATE, Subject.USER, { id: user.id }) // âœ… å…è®¸
can(user, Action.UPDATE, Subject.USER, { id: 'other-user-id' }) // âŒ æ‹’ç»ï¼ˆéç®¡ç†å‘˜ï¼‰

// VIP ç”¨æˆ·æœ‰é¢å¤–æƒé™ï¼ˆé¢„ç•™æ‰©å±•ï¼‰
can(vipUser, Action.CREATE, Subject.REPORT) // âœ… å…è®¸
can(normalUser, Action.CREATE, Subject.REPORT) // âŒ æ‹’ç»
```


## ğŸ“ˆ æ‰©å±•æƒé™ç³»ç»Ÿ

**å¦‚éœ€æ‰©å±•æƒé™åŠŸèƒ½ï¼Œå¯ä»¥ï¼š**

1. **æ·»åŠ æ–°è§’è‰²**: åœ¨ `types.ts` ä¸­å®šä¹‰ï¼Œåœ¨ `abilities.ts` ä¸­è®¾ç½®æƒé™è§„åˆ™
2. **æ·»åŠ æ–°èµ„æº**: åœ¨ `types.ts` çš„ `Subject` æšä¸¾ä¸­æ·»åŠ 
3. **è‡ªå®šä¹‰æƒé™é€»è¾‘**: åœ¨ `utils.ts` çš„ `can` å‡½æ•°ä¸­æ·»åŠ ç‰¹æ®Šå¤„ç†

å½“å‰ç³»ç»Ÿè®¾è®¡ç®€å•è€Œçµæ´»ï¼Œå¯æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€æ­¥æ‰©å±•ã€‚

