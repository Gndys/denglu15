# 支付功能全面测试计划

## 概述

本测试计划涵盖所有三种支付提供商（Stripe、WeChat Pay、Creem）的完整支付流程，包括正常流程、异常处理、webhook验证等。

## 测试环境准备

### 1. 环境变量检查
手动检查以下环境变量是否正确配置：
- `STRIPE_SECRET_KEY`, `STRIPE_PUBLIC_KEY`, `STRIPE_WEBHOOK_SECRET`
- `CREEM_API_KEY`, `CREEM_WEBHOOK_SECRET`
- `WECHAT_PAY_APP_ID`, `WECHAT_PAY_MCH_ID`, `WECHAT_PAY_API_KEY`（如需要）
- `DATABASE_URL`, `APP_BASE_URL`

### 2. 测试数据准备
- 测试用户账号
- 测试支付方式
- 测试产品配置

## 测试分类

### A. 功能测试（手动）
- 完整支付流程
- 用户界面交互
- 支付成功/失败处理
- 订阅管理功能

### B. 边界条件测试
- 网络故障恢复
- 重复支付处理
- 并发支付处理

## 测试矩阵

| 支付方式 | 订阅类型 | 币种 | 测试场景 |
|---------|---------|------|----------|
| Stripe | 月度订阅 | USD | 正常支付 |
| Stripe | 年度订阅 | USD | 支付失败 |
| Stripe | 一次性 | USD | 取消支付 |
| WeChat Pay | 月度订阅 | CNY | 正常支付 |
| WeChat Pay | 一次性 | CNY | 支付超时 |
| Creem | 月度订阅 | USD | 正常支付 |
| Creem | 年度订阅 | EUR | 退款处理 |

## 详细测试步骤

### 1. 环境检查阶段

**目标**: 确保所有支付提供商配置正确

**手动检查清单**:
- [ ] 验证 API 密钥设置
- [ ] 验证 Webhook URL 配置  
- [ ] 验证产品配置
- [ ] 验证数据库连接
- [ ] 测试 API 密钥有效性（可通过各支付提供商Dashboard验证）

### 2. 核心功能测试

**目标**: 验证所有支付相关功能正常工作

**测试内容**:
- 创建支付会话
- 查询支付状态
- 处理 Webhook
- 客户门户访问

### 3. 支付流程测试

#### 3.1 Stripe 支付流程

**正常流程**:
1. 创建用户账号
2. 选择 Stripe 月度计划
3. 完成支付流程
4. 验证订阅激活
5. 测试客户门户

**异常流程**:
1. 支付失败处理
2. 支付中断恢复
3. 重复支付防护

#### 3.2 WeChat Pay 支付流程

**正常流程**:
1. 创建用户账号
2. 选择微信支付计划
3. 扫码支付
4. 验证支付结果
5. 订阅状态确认

**异常流程**:
1. 二维码过期
2. 支付超时
3. 网络中断

#### 3.3 Creem 支付流程

**正常流程**:
1. 创建用户账号
2. 选择 Creem 计划
3. 完成支付
4. Return URL 验证
5. Webhook 处理
6. 客户门户访问

**异常流程**:
1. 签名验证失败
2. Webhook 重试
3. 订阅升级/降级

### 4. Webhook 测试

**目标**: 确保 Webhook 正确处理各种事件

**测试方法**:
- 使用 webhook 测试工具
- 模拟各种支付事件
- 验证数据库状态更新

### 5. 并发测试

**目标**: 验证系统在高并发下的稳定性

**测试场景**:
- 多用户同时支付
- 同一用户多次快速点击
- Webhook 并发处理

### 6. 数据一致性测试

**目标**: 确保支付数据的完整性和一致性

**测试点**:
- 订单状态同步
- 用户订阅状态
- 支付记录完整性
- 元数据正确性

## 回归测试清单

### 每次发布前必测项目

- [ ] 三种支付方式基本流程
- [ ] Webhook 处理正确性
- [ ] 客户门户功能
- [ ] 订阅管理功能
- [ ] 价格计算准确性
- [ ] 多语言支持
- [ ] 移动端兼容性

### 关键业务场景

- [ ] 新用户首次购买
- [ ] 老用户续费
- [ ] 订阅升级/降级
- [ ] 退款处理
- [ ] 账户迁移

## 性能测试

### 响应时间要求

- 支付页面加载: < 2秒
- 支付状态查询: < 1秒
- Webhook 处理: < 5秒
- 客户门户: < 3秒

### 并发处理能力

- 同时支付用户: 100+
- Webhook 处理: 50 TPS
- 数据库查询: < 500ms

## 安全测试

### 测试项目

- [ ] 支付数据加密
- [ ] Webhook 签名验证
- [ ] Return URL 防篡改
- [ ] 用户数据保护
- [ ] API 访问控制

### 渗透测试

- SQL 注入防护
- XSS 攻击防护
- CSRF 防护
- 支付数据泄露防护

## 监控和告警

### 关键指标

- 支付成功率
- 支付响应时间
- Webhook 成功率
- 错误率分布

### 告警设置

- 支付成功率 < 95%
- 响应时间 > 5秒
- Webhook 失败率 > 5%
- 数据库连接异常

## 测试报告模板

### 测试结果记录

```
测试日期: [日期]
测试环境: [环境]
测试人员: [姓名]

测试结果:
✅ 通过: XX 项
❌ 失败: XX 项
⚠️  警告: XX 项

关键问题:
1. [问题描述]
   - 影响: [影响程度]
   - 建议: [解决方案]

性能数据:
- 平均响应时间: XXms
- 成功率: XX%
- 并发处理: XX TPS

建议:
[测试建议和改进意见]
```

## 工具和资源

### 测试工具
- Postman (API 测试)
- Webhook.site (Webhook 测试)
- Artillery (负载测试)
- Jest (单元测试)

### 监控工具
- Sentry (错误监控)
- Datadog (性能监控)
- Stripe Dashboard
- WeChat Pay 商户平台
- Creem Dashboard

## 测试数据管理

### 测试数据隔离
- 使用独立的测试数据库
- 测试数据自动清理
- 敏感数据脱敏处理

### 测试环境管理
- 开发环境 (dev)
- 测试环境 (test)
- 预生产环境 (staging)
- 生产环境 (prod)

---

**注意事项**:
1. 所有涉及真实支付的测试必须在测试环境进行
2. 测试完成后及时清理测试数据
3. 定期更新测试用例和测试数据
4. 记录所有测试结果，建立测试历史 