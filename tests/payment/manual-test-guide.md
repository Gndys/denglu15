# 支付功能手动测试指南

本指南提供详细的手动测试步骤，确保支付功能在各种场景下正常工作。

## 测试前准备

### 1. 环境配置检查

运行自动化环境检查：
```bash
npm run test:payment:env
```

### 2. 测试账号准备

- **Stripe 测试卡号**: `4242 4242 4242 4242`
- **WeChat Pay**: 使用沙箱环境
- **Creem**: 使用测试环境密钥
- **测试邮箱**: 准备多个测试邮箱

### 3. 浏览器准备

- 打开开发者工具
- 准备无痕窗口测试
- 移动设备/响应式测试

## Stripe 支付流程测试

### 测试场景 1: 新用户 Stripe 月度订阅

**步骤**:
1. **访问注册页面**
   - 打开 `/signup`
   - 验证页面加载正常
   - 检查表单验证

2. **注册新账号**
   ```
   邮箱: test-stripe-monthly-{timestamp}@example.com
   密码: TestPassword123!
   姓名: Stripe Test User
   ```

3. **选择支付计划**
   - 登录后访问 `/pricing`
   - 点击"月度订阅 (Stripe)"
   - 验证价格显示正确

4. **完成支付流程**
   - 在 Stripe Checkout 页面填写测试卡号
   - 使用测试卡号: `4242 4242 4242 4242`
   - 过期日期: 任意未来日期 (如 12/34)
   - CVC: 任意三位数字 (如 123)
   - 姓名: 任意姓名

5. **验证支付结果**
   - 检查是否重定向到成功页面
   - 验证订阅状态已激活
   - 检查数据库中的订阅记录

**预期结果**:
- ✅ 支付成功完成
- ✅ 用户订阅状态为 active
- ✅ 收到支付确认邮件
- ✅ 数据库记录正确

### 测试场景 2: Stripe 支付失败处理

**步骤**:
1. 使用失败测试卡号: `4000 0000 0000 0002`
2. 完成其他支付信息
3. 观察错误处理

**预期结果**:
- ✅ 显示支付失败错误信息
- ✅ 用户可以重试支付
- ✅ 数据库无错误订阅记录

### 测试场景 3: Stripe 客户门户

**步骤**:
1. 登录有 Stripe 订阅的账号
2. 访问 `/dashboard/subscription`
3. 点击"管理订阅"按钮
4. 在 Stripe 客户门户中测试各种操作

**测试操作**:
- 查看账单历史
- 下载发票
- 更新支付方式
- 取消订阅（如果允许）

## WeChat Pay 支付流程测试

### 测试场景 4: WeChat Pay 扫码支付

**步骤**:
1. 注册新测试账号
2. 选择微信支付计划
3. 生成支付二维码
4. 使用微信开发者工具扫码测试

**预期结果**:
- ✅ 二维码正确生成
- ✅ 扫码后跳转正确
- ✅ 支付状态正确更新

### 测试场景 5: WeChat Pay 超时处理

**步骤**:
1. 生成支付二维码
2. 等待 5 分钟不进行支付
3. 观察超时处理

**预期结果**:
- ✅ 系统显示超时信息
- ✅ 允许重新生成二维码

## Creem 支付流程测试

### 测试场景 6: Creem 订阅支付

**步骤**:
1. 注册新测试账号
2. 选择 Creem 支付计划
3. 在 Creem 页面完成支付
4. 验证 Return URL 处理

**关键检查点**:
- Creem Checkout 页面加载
- 支付信息正确显示
- Return URL 签名验证
- Webhook 事件处理

### 测试场景 7: Creem Webhook 测试

**使用 Webhook 测试工具**:
1. 访问 webhook.site 获取测试 URL
2. 在 Creem Dashboard 配置测试 webhook
3. 触发测试事件
4. 验证签名和数据处理

## 订阅管理测试

### 测试场景 8: 订阅状态查询

**步骤**:
1. 登录有订阅的用户
2. 访问 `/dashboard/subscription`
3. 验证订阅信息显示

**检查项目**:
- 订阅状态 (active/inactive/cancelled)
- 下次扣费日期
- 订阅计划信息
- 支付历史

### 测试场景 9: 订阅升级/降级

**对于支持的提供商**:
1. 当前订阅: 月度计划
2. 升级到: 年度计划
3. 验证价格计算和生效时间

## 多语言测试

### 测试场景 10: 中英文切换

**步骤**:
1. 在中文环境下完成支付流程
2. 切换到英文环境
3. 验证支付相关文本正确显示

**检查项目**:
- 计划名称和描述
- 支付按钮文本
- 错误信息
- 邮件内容

## 移动端测试

### 测试场景 11: 移动设备支付

**测试设备**:
- iOS Safari
- Android Chrome
- 微信内置浏览器

**测试流程**:
1. 在移动设备上访问网站
2. 完成注册和登录
3. 选择支付计划
4. 完成支付流程

## 异常情况测试

### 测试场景 12: 网络中断恢复

**步骤**:
1. 开始支付流程
2. 在支付页面断开网络
3. 恢复网络连接
4. 验证状态恢复

### 测试场景 13: 重复支付防护

**步骤**:
1. 开始支付流程
2. 快速多次点击支付按钮
3. 验证只创建一个订单

### 测试场景 14: 浏览器返回处理

**步骤**:
1. 在支付页面点击浏览器返回按钮
2. 重新进入支付流程
3. 验证状态正确

## 性能测试

### 测试场景 15: 支付页面加载速度

**测试步骤**:
1. 清除浏览器缓存
2. 访问支付页面
3. 记录加载时间

**性能指标**:
- 首屏加载: < 2秒
- 支付按钮响应: < 1秒
- 重定向处理: < 3秒

### 测试场景 16: 并发用户支付

**模拟场景**:
1. 多个浏览器标签页同时支付
2. 不同用户同时支付相同计划
3. 验证系统稳定性

## 安全测试

### 测试场景 17: 支付数据安全

**检查项目**:
- 支付页面 HTTPS 加密
- 敏感数据不在 URL 中传输
- Session 和 Token 安全
- XSS 和 CSRF 防护

### 测试场景 18: 权限验证

**测试步骤**:
1. 未登录用户访问支付页面
2. 无权限用户访问管理页面
3. 验证权限检查

## 数据一致性测试

### 测试场景 19: 支付数据同步

**验证项目**:
1. 支付提供商数据与本地数据一致
2. Webhook 事件处理完整
3. 订阅状态实时更新
4. 邮件通知发送

## 回归测试清单

### 核心功能回归

每次更新后必须测试的核心场景：

- [ ] Stripe 月度订阅支付
- [ ] Stripe 年度订阅支付
- [ ] WeChat Pay 支付流程
- [ ] Creem 支付流程
- [ ] 客户门户访问
- [ ] 订阅状态查询
- [ ] 支付失败处理
- [ ] Webhook 处理

### 边界条件回归

- [ ] 网络中断恢复
- [ ] 重复支付防护
- [ ] 超时处理
- [ ] 错误状态恢复

## 测试结果记录

### 测试记录模板

```markdown
## 测试执行记录

**测试日期**: [日期]
**测试人员**: [姓名]
**测试环境**: [环境说明]
**浏览器版本**: [版本信息]

### 测试结果汇总

| 测试场景 | 状态 | 备注 |
|---------|------|------|
| Stripe 月度订阅 | ✅/❌ | |
| Stripe 年度订阅 | ✅/❌ | |
| WeChat Pay 支付 | ✅/❌ | |
| Creem 支付 | ✅/❌ | |
| 客户门户 | ✅/❌ | |
| 移动端支付 | ✅/❌ | |

### 发现的问题

1. **问题描述**: [详细描述]
   - **重现步骤**: [步骤]
   - **预期结果**: [预期]
   - **实际结果**: [实际]
   - **严重程度**: 高/中/低
   - **修复建议**: [建议]

### 性能数据

- **支付页面加载**: [时间]ms
- **支付完成时间**: [时间]ms
- **Webhook 响应**: [时间]ms

### 测试结论

[总体评估和建议]
```

## 工具推荐

### 浏览器插件

- **ModHeader**: 修改 HTTP 请求头
- **Postman Interceptor**: API 请求测试
- **Web Developer**: 禁用 JavaScript/CSS 测试

### 移动端测试

- **Chrome DevTools**: 设备模拟
- **BrowserStack**: 真实设备测试
- **微信开发者工具**: 微信环境测试

### 监控工具

- **Sentry**: 错误监控
- **Google Analytics**: 用户行为
- **New Relic**: 性能监控

---

**重要提醒**:
1. 所有涉及真实支付的测试都要在测试环境进行
2. 测试完成后及时清理测试数据
3. 记录所有异常情况和错误信息
4. 定期更新测试用例以反映功能变更 